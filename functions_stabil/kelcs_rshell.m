function [Ke,Me]=kelcs_rshell(Lx,Ly,t,d,E,nu,rho)

%KELCS_RSHELL   Rectangular thin shell element stiffness and mass matrix in LCS.
%
%   [KeLCS,MeLCS] = kelcs_rshell(Lx,Ly,t,d,E,nu,rho) returns the element
%   stiffness and mass matrix in the local coordinate system for a four-node
%   rectangular thin shell element.  The element has synthetic drilling
%   stiffness.  Shear deformation and rotational inertia are not accounted for.
%
%   Lx         Element size in x-direction.
%   Ly         Element size in y-direction.
%   t          Element thickness.
%   d          Offset in z-direction.
%   E          Young's modulus.
%   nu         Poisson coefficient.
%   rho        Mass density.
%   KeLCS      Element stiffness matrix (24 * 24).
%   MeLCS      Element mass matrix (24 * 24).
%
%   The element nodes are numbered as follows:
%
%   4           Lx            3
%     *---------------------*
%     |        y ^          |
%     |          |          |
%     |          ---> x     | Ly
%     |                     |
%     |                     |
%     *---------------------*
%   1                         2

%   The element is based on "Element A" in Zienkiewicz, Vol. 2, p. 231.

% Mattias Schevenels, David Dooms
% April 2008

% DIMENSIONS
a=Lx/2;
b=Ly/2;

% STIFFNESS MATRIX
K1=E/(1-nu^2)/a/b*t* ...
  [    1/3*b^2+1/6*a^2-1/6*a^2*nu,                1/8*b*a*(nu+1), -1/3*b^2+1/12*a^2-1/12*a^2*nu,              1/8*b*a*(3*nu-1), -1/6*b^2-1/12*a^2+1/12*a^2*nu,               -1/8*b*a*(nu+1),    1/6*b^2-1/6*a^2+1/6*a^2*nu,             -1/8*b*a*(3*nu-1);
                   1/8*b*a*(nu+1),    1/6*b^2-1/6*b^2*nu+1/3*a^2,             -1/8*b*a*(3*nu-1),   -1/6*b^2+1/6*b^2*nu+1/6*a^2,               -1/8*b*a*(nu+1), -1/12*b^2+1/12*b^2*nu-1/6*a^2,              1/8*b*a*(3*nu-1),  1/12*b^2-1/12*b^2*nu-1/3*a^2;
    -1/3*b^2+1/12*a^2-1/12*a^2*nu,             -1/8*b*a*(3*nu-1),    1/3*b^2+1/6*a^2-1/6*a^2*nu,               -1/8*b*a*(nu+1),    1/6*b^2-1/6*a^2+1/6*a^2*nu,              1/8*b*a*(3*nu-1), -1/6*b^2-1/12*a^2+1/12*a^2*nu,                1/8*b*a*(nu+1);
                 1/8*b*a*(3*nu-1),   -1/6*b^2+1/6*b^2*nu+1/6*a^2,               -1/8*b*a*(nu+1),    1/6*b^2-1/6*b^2*nu+1/3*a^2,             -1/8*b*a*(3*nu-1),  1/12*b^2-1/12*b^2*nu-1/3*a^2,                1/8*b*a*(nu+1), -1/12*b^2+1/12*b^2*nu-1/6*a^2;
    -1/6*b^2-1/12*a^2+1/12*a^2*nu,               -1/8*b*a*(nu+1),    1/6*b^2-1/6*a^2+1/6*a^2*nu,             -1/8*b*a*(3*nu-1),    1/3*b^2+1/6*a^2-1/6*a^2*nu,                1/8*b*a*(nu+1), -1/3*b^2+1/12*a^2-1/12*a^2*nu,              1/8*b*a*(3*nu-1);
                  -1/8*b*a*(nu+1), -1/12*b^2+1/12*b^2*nu-1/6*a^2,              1/8*b*a*(3*nu-1),  1/12*b^2-1/12*b^2*nu-1/3*a^2,                1/8*b*a*(nu+1),    1/6*b^2-1/6*b^2*nu+1/3*a^2,             -1/8*b*a*(3*nu-1),   -1/6*b^2+1/6*b^2*nu+1/6*a^2;
       1/6*b^2-1/6*a^2+1/6*a^2*nu,              1/8*b*a*(3*nu-1), -1/6*b^2-1/12*a^2+1/12*a^2*nu,                1/8*b*a*(nu+1), -1/3*b^2+1/12*a^2-1/12*a^2*nu,             -1/8*b*a*(3*nu-1),    1/3*b^2+1/6*a^2-1/6*a^2*nu,               -1/8*b*a*(nu+1);
                -1/8*b*a*(3*nu-1),  1/12*b^2-1/12*b^2*nu-1/3*a^2,                1/8*b*a*(nu+1), -1/12*b^2+1/12*b^2*nu-1/6*a^2,              1/8*b*a*(3*nu-1),   -1/6*b^2+1/6*b^2*nu+1/6*a^2,               -1/8*b*a*(nu+1),    1/6*b^2-1/6*b^2*nu+1/3*a^2];

K2=E*t^3/12/(1-nu^2)* ...
  [ 1/10/a^3/b^3*(7*a^2*b^2-2*b^2*nu*a^2+10*b^4+10*a^4), 1/10/a/b^2*(b^2+4*nu*b^2+10*a^2), -1/10/a^2/b*(10*b^2+4*nu*a^2+a^2), 1/10/a^3/b^3*(-7*a^2*b^2+2*b^2*nu*a^2-10*b^4+5*a^4), 1/10/a/b^2*(-b^2-4*nu*b^2+5*a^2),  1/10/a^2/b*(-10*b^2-a^2+nu*a^2), -1/10/a^3/b^3*(-7*a^2*b^2+2*b^2*nu*a^2+5*b^4+5*a^4),    1/10/a/b^2*(-b^2+nu*b^2+5*a^2),   -1/10/a^2/b*(5*b^2-a^2+nu*a^2), -1/10/a^3/b^3*(7*a^2*b^2-2*b^2*nu*a^2-5*b^4+10*a^4),    1/10/a/b^2*(b^2-nu*b^2+10*a^2),   1/10/a^2/b*(4*nu*a^2-5*b^2+a^2);
                       1/10/a/b^2*(b^2+4*nu*b^2+10*a^2),      4/15/b*(b^2-nu*b^2+5*a^2)/a,                               -nu,                    1/10/a/b^2*(-b^2-4*nu*b^2+5*a^2), 2/15/b*(-2*b^2+2*nu*b^2+5*a^2)/a,                                0,                     -1/10/a/b^2*(-b^2+nu*b^2+5*a^2),       1/15/b*(b^2-nu*b^2+5*a^2)/a,                                0,                     -1/10/a/b^2*(b^2-nu*b^2+10*a^2),     1/15/b*(-b^2+nu*b^2+10*a^2)/a,                                 0;
                      -1/10/a^2/b*(10*b^2+4*nu*a^2+a^2),                              -nu,     -4/15/a/b*(-5*b^2-a^2+nu*a^2),                    -1/10/a^2/b*(-10*b^2-a^2+nu*a^2),                                0,     1/15/a/b*(10*b^2-a^2+nu*a^2),                       1/10/a^2/b*(5*b^2-a^2+nu*a^2),                                 0,    -1/15/a/b*(-5*b^2-a^2+nu*a^2),                     1/10/a^2/b*(4*nu*a^2-5*b^2+a^2),                                 0,   2/15/a/b*(5*b^2-2*a^2+2*nu*a^2);
    1/10/a^3/b^3*(-7*a^2*b^2+2*b^2*nu*a^2-10*b^4+5*a^4), 1/10/a/b^2*(-b^2-4*nu*b^2+5*a^2),  -1/10/a^2/b*(-10*b^2-a^2+nu*a^2), 1/10/a^3/b^3*(7*a^2*b^2-2*b^2*nu*a^2+10*b^4+10*a^4), 1/10/a/b^2*(b^2+4*nu*b^2+10*a^2), 1/10/a^2/b*(10*b^2+4*nu*a^2+a^2), -1/10/a^3/b^3*(7*a^2*b^2-2*b^2*nu*a^2-5*b^4+10*a^4),    1/10/a/b^2*(b^2-nu*b^2+10*a^2), -1/10/a^2/b*(4*nu*a^2-5*b^2+a^2), -1/10/a^3/b^3*(-7*a^2*b^2+2*b^2*nu*a^2+5*b^4+5*a^4),    1/10/a/b^2*(-b^2+nu*b^2+5*a^2),     1/10/a^2/b*(5*b^2-a^2+nu*a^2);
                       1/10/a/b^2*(-b^2-4*nu*b^2+5*a^2), 2/15/b*(-2*b^2+2*nu*b^2+5*a^2)/a,                                 0,                    1/10/a/b^2*(b^2+4*nu*b^2+10*a^2),      4/15/b*(b^2-nu*b^2+5*a^2)/a,                               nu,                     -1/10/a/b^2*(b^2-nu*b^2+10*a^2),     1/15/b*(-b^2+nu*b^2+10*a^2)/a,                                0,                     -1/10/a/b^2*(-b^2+nu*b^2+5*a^2),       1/15/b*(b^2-nu*b^2+5*a^2)/a,                                 0;
                        1/10/a^2/b*(-10*b^2-a^2+nu*a^2),                                0,      1/15/a/b*(10*b^2-a^2+nu*a^2),                    1/10/a^2/b*(10*b^2+4*nu*a^2+a^2),                               nu,    -4/15/a/b*(-5*b^2-a^2+nu*a^2),                    -1/10/a^2/b*(4*nu*a^2-5*b^2+a^2),                                 0,  2/15/a/b*(5*b^2-2*a^2+2*nu*a^2),                      -1/10/a^2/b*(5*b^2-a^2+nu*a^2),                                 0,     -1/15/a/b*(-5*b^2-a^2+nu*a^2);
    -1/10/a^3/b^3*(-7*a^2*b^2+2*b^2*nu*a^2+5*b^4+5*a^4),  -1/10/a/b^2*(-b^2+nu*b^2+5*a^2),     1/10/a^2/b*(5*b^2-a^2+nu*a^2), -1/10/a^3/b^3*(7*a^2*b^2-2*b^2*nu*a^2-5*b^4+10*a^4),  -1/10/a/b^2*(b^2-nu*b^2+10*a^2), -1/10/a^2/b*(4*nu*a^2-5*b^2+a^2), 1/10/a^3/b^3*(7*a^2*b^2-2*b^2*nu*a^2+10*b^4+10*a^4), -1/10/a/b^2*(b^2+4*nu*b^2+10*a^2), 1/10/a^2/b*(10*b^2+4*nu*a^2+a^2), 1/10/a^3/b^3*(-7*a^2*b^2+2*b^2*nu*a^2-10*b^4+5*a^4), -1/10/a/b^2*(-b^2-4*nu*b^2+5*a^2),  -1/10/a^2/b*(-10*b^2-a^2+nu*a^2);
                         1/10/a/b^2*(-b^2+nu*b^2+5*a^2),      1/15/b*(b^2-nu*b^2+5*a^2)/a,                                 0,                      1/10/a/b^2*(b^2-nu*b^2+10*a^2),    1/15/b*(-b^2+nu*b^2+10*a^2)/a,                                0,                   -1/10/a/b^2*(b^2+4*nu*b^2+10*a^2),       4/15/b*(b^2-nu*b^2+5*a^2)/a,                              -nu,                   -1/10/a/b^2*(-b^2-4*nu*b^2+5*a^2),  2/15/b*(-2*b^2+2*nu*b^2+5*a^2)/a,                                 0;
                         -1/10/a^2/b*(5*b^2-a^2+nu*a^2),                                0,     -1/15/a/b*(-5*b^2-a^2+nu*a^2),                    -1/10/a^2/b*(4*nu*a^2-5*b^2+a^2),                                0,  2/15/a/b*(5*b^2-2*a^2+2*nu*a^2),                    1/10/a^2/b*(10*b^2+4*nu*a^2+a^2),                               -nu,    -4/15/a/b*(-5*b^2-a^2+nu*a^2),                     1/10/a^2/b*(-10*b^2-a^2+nu*a^2),                                 0,      1/15/a/b*(10*b^2-a^2+nu*a^2);
    -1/10/a^3/b^3*(7*a^2*b^2-2*b^2*nu*a^2-5*b^4+10*a^4),  -1/10/a/b^2*(b^2-nu*b^2+10*a^2),   1/10/a^2/b*(4*nu*a^2-5*b^2+a^2), -1/10/a^3/b^3*(-7*a^2*b^2+2*b^2*nu*a^2+5*b^4+5*a^4),  -1/10/a/b^2*(-b^2+nu*b^2+5*a^2),   -1/10/a^2/b*(5*b^2-a^2+nu*a^2), 1/10/a^3/b^3*(-7*a^2*b^2+2*b^2*nu*a^2-10*b^4+5*a^4), -1/10/a/b^2*(-b^2-4*nu*b^2+5*a^2),  1/10/a^2/b*(-10*b^2-a^2+nu*a^2), 1/10/a^3/b^3*(7*a^2*b^2-2*b^2*nu*a^2+10*b^4+10*a^4), -1/10/a/b^2*(b^2+4*nu*b^2+10*a^2), -1/10/a^2/b*(10*b^2+4*nu*a^2+a^2);
                         1/10/a/b^2*(b^2-nu*b^2+10*a^2),    1/15/b*(-b^2+nu*b^2+10*a^2)/a,                                 0,                      1/10/a/b^2*(-b^2+nu*b^2+5*a^2),      1/15/b*(b^2-nu*b^2+5*a^2)/a,                                0,                   -1/10/a/b^2*(-b^2-4*nu*b^2+5*a^2),  2/15/b*(-2*b^2+2*nu*b^2+5*a^2)/a,                                0,                   -1/10/a/b^2*(b^2+4*nu*b^2+10*a^2),       4/15/b*(b^2-nu*b^2+5*a^2)/a,                                nu;
                        1/10/a^2/b*(4*nu*a^2-5*b^2+a^2),                                0,   2/15/a/b*(5*b^2-2*a^2+2*nu*a^2),                       1/10/a^2/b*(5*b^2-a^2+nu*a^2),                                0,    -1/15/a/b*(-5*b^2-a^2+nu*a^2),                    -1/10/a^2/b*(-10*b^2-a^2+nu*a^2),                                 0,     1/15/a/b*(10*b^2-a^2+nu*a^2),                   -1/10/a^2/b*(10*b^2+4*nu*a^2+a^2),                                nu,     -4/15/a/b*(-5*b^2-a^2+nu*a^2)];

Ke=zeros(24);
Ke([1,2,7,8,13,14,19,20],[1,2,7,8,13,14,19,20])=K1;
Ke([3:5,9:11,15:17,21:23],[3:5,9:11,15:17,21:23])=K2;

% MASS MATRIX
if nargout>1
  M1=rho*t*a*b/9* ...
    [ 4, 0, 2, 0, 1, 0, 2, 0;
      0, 4, 0, 2, 0, 1, 0, 2;
      2, 0, 4, 0, 2, 0, 1, 0;
      0, 2, 0, 4, 0, 2, 0, 1;
      1, 0, 2, 0, 4, 0, 2, 0;
      0, 1, 0, 2, 0, 4, 0, 2;
      2, 0, 1, 0, 2, 0, 4, 0;
      0, 2, 0, 1, 0, 2, 0, 4];

  M2=rho*t*a*b/3150* ...
    [     1727,    461*b,   -461*a,      613,    199*b,    274*a,      197,   -116*b,    116*a,      613,   -274*b,   -199*a;
         461*b,  160*b^2, -126*b*a,    199*b,   80*b^2,   84*b*a,    116*b,  -60*b^2,   56*b*a,    274*b, -120*b^2,  -84*b*a;
        -461*a, -126*b*a,  160*a^2,   -274*a,  -84*b*a, -120*a^2,   -116*a,   56*b*a,  -60*a^2,   -199*a,   84*b*a,   80*a^2;
           613,    199*b,   -274*a,     1727,    461*b,    461*a,      613,   -274*b,    199*a,      197,   -116*b,   -116*a;
         199*b,   80*b^2,  -84*b*a,    461*b,  160*b^2,  126*b*a,    274*b, -120*b^2,   84*b*a,    116*b,  -60*b^2,  -56*b*a;
         274*a,   84*b*a, -120*a^2,    461*a,  126*b*a,  160*a^2,    199*a,  -84*b*a,   80*a^2,    116*a,  -56*b*a,  -60*a^2;
           197,    116*b,   -116*a,      613,    274*b,    199*a,     1727,   -461*b,    461*a,      613,   -199*b,   -274*a;
        -116*b,  -60*b^2,   56*b*a,   -274*b, -120*b^2,  -84*b*a,   -461*b,  160*b^2, -126*b*a,   -199*b,   80*b^2,   84*b*a;
         116*a,   56*b*a,  -60*a^2,    199*a,   84*b*a,   80*a^2,    461*a, -126*b*a,  160*a^2,    274*a,  -84*b*a, -120*a^2;
           613,    274*b,   -199*a,      197,    116*b,    116*a,      613,   -199*b,    274*a,     1727,   -461*b,   -461*a;
        -274*b, -120*b^2,   84*b*a,   -116*b,  -60*b^2,  -56*b*a,   -199*b,   80*b^2,  -84*b*a,   -461*b,  160*b^2,  126*b*a;
        -199*a,  -84*b*a,   80*a^2,   -116*a,  -56*b*a,  -60*a^2,   -274*a,   84*b*a, -120*a^2,   -461*a,  126*b*a,  160*a^2];

  Me=zeros(24);
  Me([1,2,7,8,13,14,19,20],[1,2,7,8,13,14,19,20])=M1;
  Me([3:5,9:11,15:17,21:23],[3:5,9:11,15:17,21:23])=M2;
end

% ADD DRILLING STIFFNESS
alpha=1e-6;
k=1/2/(Lx+Ly)*[-1 1 0 0 0 0 -1 -1 0 0 0 0 1 -1 0 0 0 0 1 1 0 0 0 0];
Kd=zeros(24);
Kd([6:6:24],:)=repmat(k,4,1);
Kd(:,[6:6:24])=repmat(k,4,1)';
Kd(6,6)=1;
Kd(12,12)=1;
Kd(18,18)=1;
Kd(24,24)=1;
Kd=alpha*E*t^3*Kd;
Ke=Ke+Kd;

% APPLY OFFSET
if d~=0
  Tn=eye(6);
  Tn(1,5)=d;
  Tn(2,4)=-d;
  T=blkdiag(Tn,Tn,Tn,Tn);
  Ke=T'*Ke*T;
  if nargout>1
    Me=T'*Me*T;
  end
end